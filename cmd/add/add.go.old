// file: cmd/add/add.go

package add

import (
	"fmt"
	"path/filepath"
	"strings"
	"github.com/ha1tch/plus3/pkg/diskimg"
)

type AddOptions struct {
	AsBasic    bool
	AsCode     bool
	AsScreen   bool
	Line       uint16
	LoadAddr   uint16
}

func Add(diskPath string, filePath string, opts AddOptions) error {
	disk, err := diskimg.LoadFromFile(diskPath)
	if err != nil {
		return fmt.Errorf("failed to open disk: %v", err)
	}

	ext := strings.ToLower(filepath.Ext(filePath))
	switch {
	case opts.AsBasic || ext == ".bas":
		err = disk.ImportBasicProgram(filePath, opts.Line)
	case opts.AsCode || ext == ".bin":
		err = disk.ImportCode(filePath, opts.LoadAddr)
	case opts.AsScreen || ext == ".scr":
		err = disk.ImportScreen(filePath)
	default:
		err = disk.ImportRaw(filePath)
	}

	if err != nil {
		return fmt.Errorf("failed to import file: %v", err)
	}

	return disk.SaveToFile(diskPath)
}